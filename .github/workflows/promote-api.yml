# =============================================================================
# Workflow: Promote API Between Environments
# =============================================================================
# Promociona una API de un entorno a otro (UAT -> NFT -> PRO)
#
# ESTRUCTURA (v3 - Sin Revisiones):
#   apis/{APIName}/
#     state.yaml
#     {Version}/
#       api.yaml, Definitions/, Conf/
#
# =============================================================================

name: Promote API

on:
  workflow_dispatch:
    inputs:
      subdominio:
        description: 'Subdominio/Repo destino (ej: rrhh-empleados)'
        required: true
        type: string
      api_name:
        description: 'Nombre de la API'
        required: true
        type: string
      api_version:
        description: 'Versión (ej: 1.0.0)'
        required: true
        type: string
      source_env:
        description: 'Entorno origen'
        required: true
        type: choice
        options:
          - uat
          - nft
      target_env:
        description: 'Entorno destino'
        required: true
        type: choice
        options:
          - nft
          - pro

  repository_dispatch:
    types: [promote-api]

env:
  CONFIG_FILE: repo-config.yaml

permissions:
  contents: read
  issues: write
  actions: read

jobs:
  promote:
    runs-on: ubuntu-latest
    steps:
      # -----------------------------------------------------------------------
      # Paso 1: Extraer parámetros
      # -----------------------------------------------------------------------
      - name: Extract parameters
        id: params
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "subdominio=${{ inputs.subdominio }}" >> $GITHUB_OUTPUT
            echo "api_name=${{ inputs.api_name }}" >> $GITHUB_OUTPUT
            echo "api_version=${{ inputs.api_version }}" >> $GITHUB_OUTPUT
            echo "source_env=${{ inputs.source_env }}" >> $GITHUB_OUTPUT
            echo "target_env=${{ inputs.target_env }}" >> $GITHUB_OUTPUT
          else
            echo "subdominio=${{ github.event.client_payload.subdominio }}" >> $GITHUB_OUTPUT
            echo "api_name=${{ github.event.client_payload.api_name }}" >> $GITHUB_OUTPUT
            echo "api_version=${{ github.event.client_payload.api_version }}" >> $GITHUB_OUTPUT
            echo "source_env=${{ github.event.client_payload.source_env }}" >> $GITHUB_OUTPUT
            echo "target_env=${{ github.event.client_payload.target_env }}" >> $GITHUB_OUTPUT
          fi

      # -----------------------------------------------------------------------
      # Paso 2: Validar flujo de promoción
      # -----------------------------------------------------------------------
      - name: Validate promotion flow
        id: validate
        run: |
          SOURCE="${{ steps.params.outputs.source_env }}"
          TARGET="${{ steps.params.outputs.target_env }}"

          VALID=false
          if [ "$SOURCE" == "uat" ] && [ "$TARGET" == "nft" ]; then
            VALID=true
          elif [ "$SOURCE" == "nft" ] && [ "$TARGET" == "pro" ]; then
            VALID=true
          fi

          if [ "$VALID" != "true" ]; then
            echo "::error::Flujo de promoción inválido: ${SOURCE} -> ${TARGET}"
            echo "Flujos permitidos: uat->nft, nft->pro"
            exit 1
          fi

          echo "valid=true" >> $GITHUB_OUTPUT
          echo "::notice::Promoción válida: ${SOURCE} -> ${TARGET}"

      # -----------------------------------------------------------------------
      # Paso 3: Checkout repos
      # -----------------------------------------------------------------------
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Get target repo info
        id: repo-info
        run: |
          SUBDOMINIO="${{ steps.params.outputs.subdominio }}"

          if [ -f "$CONFIG_FILE" ]; then
            REPO=$(yq e ".subdominios[] | select(.nombre == \"${SUBDOMINIO}\") | .repo" "$CONFIG_FILE" 2>/dev/null || \
                   grep -A5 "^  ${SUBDOMINIO}:" "$CONFIG_FILE" | grep "git_repo:" | head -1 | awk '{print $2}')
          fi

          if [ -z "$REPO" ] || [ "$REPO" == "null" ]; then
            echo "::error::Subdominio '${SUBDOMINIO}' no encontrado en ${CONFIG_FILE}"
            exit 1
          fi

          echo "target_repo=${REPO}" >> $GITHUB_OUTPUT
          echo "::notice::Repo destino: ${REPO}"

      - name: Checkout domain repo
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.repo-info.outputs.target_repo }}
          token: ${{ secrets.SUBDOMINIO_PAT }}
          path: domain-repo

      # -----------------------------------------------------------------------
      # Paso 4: Verificar que la versión existe
      # -----------------------------------------------------------------------
      - name: Verify version exists
        id: verify
        working-directory: domain-repo
        run: |
          API_NAME="${{ steps.params.outputs.api_name }}"
          API_VERSION="${{ steps.params.outputs.api_version }}"

          VERSION_PATH="apis/${API_NAME}/${API_VERSION}"

          if [ ! -d "$VERSION_PATH" ]; then
            echo "::error::Versión no encontrada: ${VERSION_PATH}"
            exit 1
          fi

          if [ ! -f "${VERSION_PATH}/Conf/params.yaml" ]; then
            echo "::error::params.yaml no encontrado en ${VERSION_PATH}/Conf/"
            exit 1
          fi

          echo "version_path=${VERSION_PATH}" >> $GITHUB_OUTPUT
          echo "::notice::Versión verificada: ${VERSION_PATH}"

      # -----------------------------------------------------------------------
      # Paso 5: Verificar estado actual
      # -----------------------------------------------------------------------
      - name: Check current state
        id: state
        working-directory: domain-repo
        run: |
          API_NAME="${{ steps.params.outputs.api_name }}"
          SOURCE_ENV="${{ steps.params.outputs.source_env }}"

          STATE_FILE="apis/${API_NAME}/state.yaml"

          if [ ! -f "$STATE_FILE" ]; then
            echo "::error::state.yaml no encontrado para ${API_NAME}"
            exit 1
          fi

          # Verificar que está registrado en origen
          SOURCE_STATUS=$(grep -A3 "^  ${SOURCE_ENV}:" "$STATE_FILE" | grep "status:" | head -1 | awk '{print $2}')

          if [ "$SOURCE_STATUS" != "REGISTERED" ] && [ "$SOURCE_STATUS" != "DEPLOYED" ]; then
            echo "::error::API no está registrada/desplegada en ${SOURCE_ENV} (status: ${SOURCE_STATUS})"
            exit 1
          fi

          echo "source_status=${SOURCE_STATUS}" >> $GITHUB_OUTPUT
          echo "::notice::Estado en ${SOURCE_ENV}: ${SOURCE_STATUS}"

      # -----------------------------------------------------------------------
      # Paso 6: Actualizar state.yaml
      # -----------------------------------------------------------------------
      - name: Update state
        working-directory: domain-repo
        run: |
          API_NAME="${{ steps.params.outputs.api_name }}"
          API_VERSION="${{ steps.params.outputs.api_version }}"
          TARGET_ENV="${{ steps.params.outputs.target_env }}"

          STATE_FILE="apis/${API_NAME}/state.yaml"

          # Actualizar timestamp
          sed -i.bak "s/^last_updated:.*/last_updated: $(date -u +%Y-%m-%dT%H:%M:%SZ)/" "$STATE_FILE"

          # Actualizar sección del entorno target
          # Por simplicidad, añadimos info al final o usamos sed
          echo ""
          echo "=== Actualizando state.yaml para ${TARGET_ENV} ==="

          # Crear backup y actualizar
          cat "$STATE_FILE"

      # -----------------------------------------------------------------------
      # Paso 7: Commit y push cambios
      # -----------------------------------------------------------------------
      - name: Commit state change
        working-directory: domain-repo
        run: |
          API_NAME="${{ steps.params.outputs.api_name }}"
          API_VERSION="${{ steps.params.outputs.api_version }}"
          TARGET_ENV="${{ steps.params.outputs.target_env }}"
          SOURCE_ENV="${{ steps.params.outputs.source_env }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "apis/${API_NAME}/state.yaml"

          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "promote: ${API_NAME} v${API_VERSION} ${SOURCE_ENV} -> ${TARGET_ENV}

Automated promotion by apim-apiops-controller"
            git push
          fi

      # -----------------------------------------------------------------------
      # Paso 8: Mostrar resumen
      # -----------------------------------------------------------------------
      - name: Summary
        run: |
          API_NAME="${{ steps.params.outputs.api_name }}"
          API_VERSION="${{ steps.params.outputs.api_version }}"
          TARGET_ENV="${{ steps.params.outputs.target_env }}"
          SOURCE_ENV="${{ steps.params.outputs.source_env }}"
          SUBDOMINIO="${{ steps.params.outputs.subdominio }}"

          echo "=========================================="
          echo "  PROMOCIÓN COMPLETADA"
          echo "=========================================="
          echo "  API:        ${API_NAME}"
          echo "  Version:    ${API_VERSION}"
          echo "  From:       ${SOURCE_ENV}"
          echo "  To:         ${TARGET_ENV}"
          echo "  Subdominio: ${SUBDOMINIO}"
          echo "=========================================="
          echo ""
          echo "TODO: Integrar con apim-exporter-wso2 para deploy real"

          echo "## Promoción Completada" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Campo | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| API | ${API_NAME} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${API_VERSION} |" >> $GITHUB_STEP_SUMMARY
          echo "| From | ${SOURCE_ENV} |" >> $GITHUB_STEP_SUMMARY
          echo "| To | ${TARGET_ENV} |" >> $GITHUB_STEP_SUMMARY
